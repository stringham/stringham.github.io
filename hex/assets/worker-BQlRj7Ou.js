(function(){"use strict";const B=30*Math.sqrt(3)/2,L=[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0},{x:5,y:0},{x:6,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:3,y:1},{x:4,y:1},{x:5,y:1},{x:6,y:1},{x:7,y:1},{x:-2,y:2},{x:-1,y:2},{x:0,y:2},{x:1,y:2},{x:2,y:2},{x:3,y:2},{x:4,y:2},{x:5,y:2},{x:6,y:2},{x:7,y:2},{x:8,y:2},{x:-2,y:3},{x:-1,y:3},{x:0,y:3},{x:1,y:3},{x:2,y:3},{x:3,y:3},{x:4,y:3},{x:5,y:3},{x:6,y:3},{x:7,y:3},{x:8,y:3},{x:-1,y:4},{x:0,y:4},{x:1,y:4},{x:2,y:4},{x:3,y:4},{x:4,y:4},{x:5,y:4},{x:6,y:4},{x:7,y:4},{x:0,y:5},{x:1,y:5},{x:2,y:5},{x:3,y:5},{x:4,y:5},{x:5,y:5},{x:6,y:5}],yo=[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:3,y:1},{x:4,y:1},{x:5,y:1},{x:-1,y:2},{x:0,y:2},{x:1,y:2},{x:2,y:2},{x:3,y:2},{x:4,y:2},{x:5,y:2},{x:0,y:3},{x:1,y:3},{x:2,y:3},{x:3,y:3},{x:4,y:3}],lo=1,xo=7,Z=["#E63946","#F1FAEE","#A8DADC","#457B9D","#1D3557","#F4A261","#2A9D8F","#E9C46A","#264653","#D62828","#8D99AE","#EF476F","#06D6A0","#118AB2","#073B4C"],oo=10,ho=110,F=(n,t)=>(n+oo)*ho+(t+oo),O=n=>Math.abs(n.x+n.y)%2===0,to=n=>{const t=n.x*30/2,o=n.y*B;return{x:t,y:o}},$=n=>{const{x:t,y:o}=to(n);return O(n)?{x:t+30/2,y:o+B*.666}:{x:t+30/2,y:o+B*.333}},X=n=>{const{x:t,y:o}=to(n);return O(n)?{x:t+30/2,y:o}:{x:t+30/2,y:o+B}},K=n=>{const t=Math.round(n.y/B),o=Math.round(n.x/(30/2)),l=[{x:o,y:t},{x:o+1,y:t},{x:o-1,y:t},{x:o,y:t+1},{x:o,y:t-1},{x:o+1,y:t+1},{x:o-1,y:t-1}];let s=l[0],e=1/0;for(const a of l){const c=$(a),i=c.x-n.x,r=c.y-n.y,y=i*i+r*r;y<e&&(e=y,s=a)}return s},uo=n=>{if(n.length<=1)return!0;const t=new Set(n.map(e=>`${e.x},${e.y}`)),o=new Set,l=[n[0]];o.add(`${n[0].x},${n[0].y}`);let s=0;for(;l.length>0;){const e=l.pop();s++;const a=O(e),c=[{x:e.x+1,y:e.y},{x:e.x-1,y:e.y},a?{x:e.x,y:e.y+1}:{x:e.x,y:e.y-1}];for(const i of c){const r=`${i.x},${i.y}`;t.has(r)&&!o.has(r)&&(o.add(r),l.push(i))}}return s===n.length},G=n=>{if(n.length===0)return[];const t=[...n].sort((i,r)=>i.y-r.y||i.x-r.x),o=t[0],s=Math.abs(o.x+o.y)%2!==0?1:0,e=0,a=o.x-s,c=o.y-e;return t.map(i=>({x:i.x-a,y:i.y-c}))},R=n=>[...n].sort((o,l)=>o.y-l.y||o.x-l.x).map(o=>`${o.x},${o.y}`).join("|"),so=(n,t)=>{if(n.length===0)return[];const o=t*Math.PI/180,l=Math.cos(o),s=Math.sin(o),e=n[0],a=X(e),c=n.map(i=>{const r=$(i),y=r.x-a.x,d=r.y-a.y,h=y*l-d*s,w=y*s+d*l;return K({x:a.x+h,y:a.y+w})});return G(c)},fo=n=>{const t=n.map(o=>({x:-o.x,y:o.y}));return G(t)},k=n=>{const t=G(n),o={},l=e=>{if(!uo(e))return;const a=G(e),c=R(a);o[c]=a};for(let e=0;e<360;e+=60)l(so(t,e));const s=fo(t);for(let e=0;e<360;e+=60)l(so(s,e));return Object.values(o)},no=n=>{if(n.length===0)return{x:0,y:0};let t=0,o=0;return n.forEach(l=>{const s=$(l);t+=s.x,o+=s.y}),{x:t/n.length,y:o/n.length}},eo=(n,t)=>{const o=new Set,l=n.map(s=>{const e=$(s);return{x:e.x-t.x,y:e.y-t.y}});for(let s=0;s<=1;s++){let e=l.map(a=>({x:s?-a.x:a.x,y:a.y}));for(let a=0;a<360;a+=60){const c=a*Math.PI/180,i=Math.cos(c),r=Math.sin(c),y=e.map(h=>({x:h.x*i-h.y*r,y:h.x*r+h.y*i})),d=[];for(const h of y){const w=h.x+t.x,f=h.y+t.y,m=K({x:w,y:f});d.push(F(m.x,m.y))}d.sort((h,w)=>h-w),o.add(d.join("|"))}}return Array.from(o)},co=(n,t)=>{let o=[];if(n.forEach(c=>{const i=t[c.pieceId];c.placedCoords.forEach(r=>o.push({x:r.x,y:r.y,val:i}))}),o.length===0)return"";const l=[],s=c=>{if(c.length===0)return[];const i=[...c].sort((f,m)=>f.y-m.y||f.x-m.x),r=i[0],d=Math.abs(r.x+r.y)%2!==0?1:0,h=r.x-d,w=r.y;return i.map(f=>({x:f.x-h,y:f.y-w,val:f.val}))},e=c=>[...c].sort((r,y)=>r.y-y.y||r.x-y.x).map(r=>`${r.x},${r.y}:${r.val}`).join("|");for(let c=0;c<360;c+=60){const i=o[0],r=X(i),y=c*Math.PI/180,d=Math.cos(y),h=Math.sin(y),w=o.map(f=>{const m=$(f),C=m.x-r.x,p=m.y-r.y,S=C*d-p*h,x=C*h+p*d,E=K({x:r.x+S,y:r.y+x});return{x:E.x,y:E.y,val:f.val}});l.push(e(s(w)))}const a=o.map(c=>({x:-c.x,y:c.y,val:c.val}));for(let c=0;c<360;c+=60){const i=a[0],r=X(i),y=c*Math.PI/180,d=Math.cos(y),h=Math.sin(y),w=a.map(f=>{const m=$(f),C=m.x-r.x,p=m.y-r.y,S=C*d-p*h,x=C*h+p*d,E=K({x:r.x+S,y:r.y+x});return{x:E.x,y:E.y,val:f.val}});l.push(e(s(w)))}return l.sort(),l[0]};class j{left;right;up;down;col;rowData=null;constructor(){this.left=this,this.right=this,this.up=this,this.down=this,this.col=this}}class P extends j{size=0;name;originalCapacity=1;currentCapacity=1;constructor(t,o=1){super(),this.name=t,this.originalCapacity=o,this.currentCapacity=o,this.col=this}cover(){if(this.currentCapacity--,!(this.currentCapacity>0)){this.right.left=this.left,this.left.right=this.right;for(let t=this.down;t!==this;t=t.down)for(let o=t.right;o!==t;o=o.right)o.down.up=o.up,o.up.down=o.down,o.col.size--}}uncover(){if(this.currentCapacity>0){this.currentCapacity++;return}this.currentCapacity++;for(let t=this.up;t!==this;t=t.up)for(let o=t.left;o!==t;o=o.left)o.col.size++,o.down.up=o,o.up.down=o;this.right.left=this,this.left.right=this}}class ro{header;solutions=[];maxSolutions=1;stopRef={current:!1};onFound;constructor(){this.header=new P("root")}search(t){if(this.stopRef.current||this.solutions.length>=this.maxSolutions)return;if(this.header.right===this.header){const s=t.map(e=>e.rowData);this.solutions.push(s),this.onFound&&this.onFound(s);return}let o=this.header.right,l=1/0;for(let s=this.header.right;s!==this.header;s=s.right)s.size<l&&(l=s.size,o=s);if(o.size!==0){o.cover();for(let s=o.down;s!==o;s=s.down){t.push(s);for(let e=s.right;e!==s;e=e.right)e.col.cover();this.search(t),s=t.pop();for(let e=s.left;e!==s;e=e.left)e.col.uncover()}o.uncover()}}}const Q=(n,t,o,l,s,e,a)=>{const c=new ro;c.maxSolutions=l*12,c.stopRef=o;const i=new Map,r=new Set,y=no(n);n.forEach(p=>{const S=F(p.x,p.y),x=new P(`cell_${S}`,1);r.add(S),i.set(S,x);const E=c.header.left;E.right=x,x.left=E,x.right=c.header,c.header.left=x});const d=new Map;let h=null;t.length>0&&t[0].count===1&&(h=t[0].id);const w=new Set;t.forEach(p=>{if(p.count>0){const S=new P(p.id,p.count);d.set(p.id,S);const x=c.header.left;x.right=S,S.left=x,S.right=c.header,c.header.left=S}});const f=(p,S)=>{const x=new j;x.rowData=S,x.col=p[0];let E=p[0];E.size++;const v=E.up;v.down=x,x.up=v,x.down=E,E.up=x;let T=x;for(let g=1;g<p.length;g++){const b=new j;b.rowData=S,b.col=p[g],E=p[g],E.size++;const M=E.up;M.down=b,b.up=M,b.down=E,E.up=b,T.right=b,b.left=T,T=b}T.right=x,x.left=T};for(const p of t){if(p.count===0)continue;const S=d.get(p.id),x=k(p.coords),E=[],v=new Set;x.forEach(T=>{const b=[...T].sort((M,A)=>M.y-A.y||M.x-A.x).map(M=>`${M.x},${M.y}`).join("|");v.has(b)||(v.add(b),E.push(T))});for(const T of E){const g=T[0],b=O(g);for(const M of n){if(O(M)!==b)continue;const A=M.x-g.x,I=M.y-g.y,N=[];let U=!0;const V=[];for(const J of T){const z=J.x+A,W=J.y+I,_=F(z,W),Y=i.get(_);if(!Y){U=!1;break}N.push(Y),V.push({x:z,y:W})}if(U){if(p.id===h){const z=V.map(_=>F(_.x,_.y)).sort((_,Y)=>_-Y).join("|");if(w.has(z))continue;eo(V,y).forEach(_=>w.add(_)),w.add(z)}f([S,...N],{pieceId:p.id,placedCoords:V,color:p.color})}}}}const m=new Set,C=[];return c.onFound=p=>{if(C.length>=l){o.current=!0;return}const S=co(p,a);m.has(S)||(m.add(S),C.push(p),s(p))},c.search([]),C},po=(n,t)=>{const o=[],l=n.flatMap(a=>Array(a.count).fill({...a,count:1})),s=new Set,e=(a,c,i)=>{if(c===t){const r=[...i].sort((d,h)=>d.id.localeCompare(h.id)),y=r.map(d=>d.id).join(",");if(!s.has(y)){s.add(y);const d=new Map;r.forEach(f=>d.set(f.id,(d.get(f.id)||0)+1));const h=[],w=[];n.forEach(f=>{const m=d.get(f.id)||0,C=f.count-m;m>0&&h.push({...f,count:m}),C>0&&w.push({...f,count:C})}),o.push({piecesA:h,piecesB:w})}return}a>=l.length||c>t||(e(a+1,c+l[a].coords.length,[...i,l[a]]),e(a+1,c,i))};return e(0,0,[]),console.log(o),o},go=no(L),ao=n=>{const t=new Set,o=[],l=a=>{const i=k(a).map(R);return i.sort(),i[0]},s=[{coords:[{x:0,y:0}]}],e=new Set;for(;s.length>0;){const{coords:a}=s.shift(),c=G(a),i=R(c);if(e.has(i))continue;if(e.add(i),a.length===n){const y=l(a);t.has(y)||(t.add(y),o.push(c));continue}const r=new Set(a.map(y=>`${y.x},${y.y}`));a.forEach(y=>{const d=O(y);[{x:y.x+1,y:y.y},{x:y.x-1,y:y.y},d?{x:y.x,y:y.y+1}:{x:y.x,y:y.y-1}].forEach(w=>{const f=`${w.x},${w.y}`;r.has(f)||s.push({coords:[...a,w]})})})}return o};function q(n,t){if(t>n.length||t<=0)return[];if(t===n.length)return[n];if(t===1)return n.map(l=>[l]);const o=[];for(let l=0;l<=n.length-t+1;l++){const s=q(n.slice(l+1),t-1);for(let e=0;e<s.length;e++)o.push([n[l],...s[e]])}return o}const mo=(n,t)=>{const o={},l=new Set(t.map(s=>F(s.x,s.y)));for(const s of n){const e=[],a=k(s.coords),c=new Set,i=[];a.forEach(r=>{const d=[...r].sort((h,w)=>h.y-w.y||h.x-w.x).map(h=>`${h.x},${h.y}`).join("|");c.has(d)||(c.add(d),i.push(r))});for(const r of i){const y=r[0],d=O(y);for(const h of t){if(O(h)!==d)continue;const w=h.x-y.x,f=h.y-y.y;let m=!0;const C=new Set,p=[];for(const S of r){const x=S.x+w,E=S.y+f,v=F(x,E);if(!l.has(v)){m=!1;break}p.push({x,y:E}),C.add(v)}m&&e.push({pieceId:s.id,placedCoords:p,color:s.color,coordKeys:C})}}o[s.id]=e}return o},So=(n,t,o)=>{const l=new Map;L.forEach(c=>{const i=F(c.x,c.y),r=new P("",1);l.set(i,r);const y=o.header.left;y.right=r,r.left=y,r.right=o.header,o.header.left=r});const s=new Map,e=n.length>0?n[0].id:null,a=new Set;n.forEach(c=>{const i=new P(c.id,c.count);s.set(c.id,i);const r=o.header.left;r.right=i,i.left=r,i.right=o.header,o.header.left=i});for(const c of n){const i=s.get(c.id),r=t[c.id];if(r)for(const y of r){if(c.id===e){const x=Array.from(y.coordKeys).sort((v,T)=>v-T).join("|");if(a.has(x))continue;eo(y.placedCoords,go).forEach(v=>a.add(v)),a.add(x)}const d=[i];let h=!0;for(const S of y.coordKeys){const x=l.get(S);if(!x){h=!1;break}d.push(x)}if(!h)continue;const w={pieceId:c.id,placedCoords:y.placedCoords,color:y.color},f=new j;f.rowData=w,f.col=d[0];let m=d[0];m.size++;let C=m.up;C.down=f,f.up=C,f.down=m,m.up=f;let p=f;for(let S=1;S<d.length;S++){const x=new j;x.rowData=w,x.col=d[S],m=d[S],m.size++;const E=m.up;E.down=x,x.up=E,x.down=m,m.up=x,p.right=x,x.left=p,p=x}p.right=f,f.left=p}}},wo=(n,t,o,l)=>{const s=new ro;s.maxSolutions=t,s.stopRef=o,So(n,l,s),s.search([]);const e=new Set,a={};n.forEach(i=>{if(!a[i.id]){const y=k(i.coords).map(R).sort();a[i.id]=y[0]}});let c=0;for(const i of s.solutions){const r=co(i,a);e.has(r)||(e.add(r),c++)}return c},u={crown:{id:"crown",coords:[{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:3,y:1},{x:4,y:1},{x:2,y:0}],color:"#F1FAEE"},hexagon:{id:"hexagon",coords:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}],color:"#773ca5ff"},pistol:{id:"pistol",coords:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:3,y:1},{x:1,y:2}],color:"#f4ee41"},club:{id:"club",coords:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0},{x:4,y:1}],color:"#21c249"},sphinx:{id:"sphinx",coords:[{x:1,y:1},{x:2,y:1},{x:3,y:1},{x:4,y:1},{x:5,y:1},{x:2,y:0}],color:"#a6a9aa"},bar:{id:"bar",coords:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0},{x:5,y:0}],color:"#418d46"},butterfly:{id:"butterfly",coords:[{x:0,y:0},{x:-2,y:1},{x:-1,y:1},{x:0,y:1},{x:1,y:1},{x:-1,y:2}],color:"#fd6d2a"},lobster:{id:"lobster",coords:[{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0},{x:2,y:1},{x:3,y:1}],color:"#9c2638"},snake:{id:"snake",coords:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:3,y:1},{x:3,y:2}],color:"#0f85d3"},chevron:{id:"chevron",coords:[{x:1,y:0},{x:2,y:0},{x:2,y:1},{x:3,y:1},{x:4,y:1},{x:5,y:1}],color:"#c03328"},hook:{id:"hook",coords:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:3,y:1}],color:"#14b0b6"},yacht:{id:"yacht",coords:[{x:0,y:0},{x:2,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1},{x:2,y:1}],color:"#f3587f"}},H={id:"triamond",coords:[{x:0,y:0},{x:1,y:0},{x:2,y:0}],color:"#e3bd6e"},Eo=()=>[...Object.values(u),H];({...u.butterfly},{...u.crown}),{...u.pistol},{...u.lobster},{...u.sphinx},{...u.club},{...u.snake},{...u.hexagon},{...H},{...u.yacht},{...u.club},{...u.snake},{...u.chevron},{...u.butterfly},{...u.crown},{...u.lobster},{...u.sphinx},{...H},{...u.yacht},{...u.bar},{...u.snake},{...u.chevron},{...u.butterfly},{...u.crown},{...u.lobster},{...u.sphinx},{...H},{...u.hexagon},{...u.bar},{...u.sphinx},{...u.club},{...u.hook},{...u.chevron},{...u.yacht},{...H},{...u.crown},{...u.hexagon},{...u.pistol},{...u.club},{...u.sphinx},{...u.bar},{...u.butterfly},{...u.lobster},{...u.snake},{...u.chevron},{...u.hook},{...u.yacht},{...H};const io=5e4,D={current:!1};self.onmessage=async n=>{const{type:t,payload:o}=n.data;try{if(t==="SOLVE_SINGLE"){D.current=!1;const{pieces:l,pieceIdToHash:s}=o;self.postMessage({type:"STATUS",payload:"Solving..."});const e=Q(L,l,D,5e4,a=>{self.postMessage({type:"SOL_FOUND",payload:a})},"single",s);self.postMessage({type:"SOLVE_FINISHED_SINGLE",payload:e}),self.postMessage({type:"DONE"})}else if(t==="SOLVE_DOUBLE"){D.current=!1;const{pieces:l,pieceIdToHash:s}=o;self.postMessage({type:"STATUS",payload:"Calculating partitions..."});const e=po(l,54);let a=0;for(let c=0;c<e.length&&!D.current;c++){const{piecesA:i,piecesB:r}=e[c];self.postMessage({type:"STATUS",payload:`Partition ${c+1}/${e.length}... (${a} found)`});const y=Q(yo,r,D,5e3,()=>{},"double",s);if(y.length>0){const d=Q(L,i,D,5e3,h=>{const w=y[0].map(f=>({...f,placedCoords:f.placedCoords.map(m=>({x:m.x+lo,y:m.y+xo}))}));self.postMessage({type:"SOL_FOUND",payload:[...h,...w]})},"double",s);d.length>0&&(self.postMessage({type:"PARTITION_FOUND",payload:{piecesA:i,piecesB:r,solutionsA:d,solutionsB:y}}),a++)}}self.postMessage({type:"DONE",payload:`Finished. Found ${a} valid splits.`})}else if(t==="MINE"){D.current=!1;const{allowSplitPieces:l,allow4xTriamonds:s}=o;self.postMessage({type:"STATUS",payload:"Generating shapes..."});const e=ao(6),a=l||s?ao(3):[];if(e.length<9){self.postMessage({type:"ERROR",payload:"Could not generate shapes"});return}self.postMessage({type:"STATUS",payload:"Matching standard shapes..."});const c=Eo(),i=new Map;c.forEach(g=>{const M=k(g.coords).map(R).sort();i.set(M[0],{id:g.id,color:g.color})});const r=(g,b,M)=>{const I=k(g).map(R).sort()[0],N=i.get(I);return N||{id:`${M}-${b}`,color:"#333"}};self.postMessage({type:"STATUS",payload:"Pre-computing geometries..."});const y=e.map((g,b)=>{const M=r(g,b,"hex");return{id:M.id,coords:g,count:1,color:M.color}}),d=a.map((g,b)=>({coords:g,info:r(g,b,"tri")})),h=d.map(g=>({id:g.info.id,coords:g.coords,count:2,color:g.info.color})),w=d.map(g=>({id:g.info.id,coords:g.coords,count:4,color:g.info.color})),f=[...y,...d.map(g=>({id:g.info.id,coords:g.coords,count:1,color:g.info.color}))],m=mo(f,L);self.postMessage({type:"STATUS",payload:"Generating combinations..."});const C=q(y,9);let p=[];l&&a.length>0&&q(y,8).forEach(b=>{h.forEach(M=>{p.push([...b,M])})});let S=[];s&&a.length>0&&q(y,7).forEach(b=>{w.forEach(M=>{S.push([...b,M])})});const x=[...C,...p,...S];x.sort(()=>Math.random()-.5);let E=0;const v=x.length;let T=0;self.postMessage({type:"STATUS",payload:`Evaluated 0 / ${v}`});for(const g of x){if(D.current)break;E++;const b=g.map((A,I)=>({...A,color:A.color!=="#333"?A.color:Z[I%Z.length]}));(E%5===0||E===v)&&self.postMessage({type:"STATUS",payload:`Evaluated ${E} / ${v} (Found ${T})`});const M=wo(b,io,D,m);if(M>0&&M<io){T++;const A=b.reduce((N,U)=>U.id.includes("tri")||U.id==="triamond"?N+U.count:N,0);let I="Standard (9x6)";A===2&&(I="Mixed (8x6 + 2x3)"),A===4&&(I="Mixed (7x6 + 4x3)"),self.postMessage({type:"INVENTORY_FOUND",payload:{count:M,pieces:b,description:I}})}}self.postMessage({type:"DONE"})}}catch(l){console.error(l),self.postMessage({type:"ERROR",payload:l.message})}}})();
